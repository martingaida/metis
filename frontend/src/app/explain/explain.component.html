<div class="container">
  <div class="explain-wrapper">
    <!-- Mode toggle -->
    <mat-button-toggle-group [(ngModel)]="mode" [hideSingleSelectionIndicator]="true" class="mode-toggle rounded-toggle" [disabled]="isLoading || isLoadingArXiv">
      <mat-button-toggle value="arXiv">arXiv</mat-button-toggle>
      <mat-button-toggle value="Custom">Custom</mat-button-toggle>
    </mat-button-toggle-group>
    <!-- arXiv mode -->
    <ng-container *ngIf="mode === 'arXiv'">
      <div class="arxiv-buttons">
        <button *ngFor="let paper of arXivPapers" 
            (click)="explainArXiv(paper)" 
            [disabled]="isExplainDisabled"
            [class.explained]="isPaperExplained(paper.id)">
          {{ paper.title }}
        </button>
      </div>
      <button *ngIf="isLoadingArXiv" disabled class="custom-btn-arxiv">
        Loading...
      </button>
      <mat-progress-bar *ngIf="isLoadingArXiv || isLoading" mode="indeterminate" class="arxiv-progress-bar"></mat-progress-bar>
    </ng-container>
    <!-- Custom mode -->
    <ng-container *ngIf="mode === 'Custom'">
        <textarea 
        class="custom-textarea" 
        id="textInput" 
        rows="6" 
        [(ngModel)]="inputText"
        placeholder="Enter a topic, text, or concept to explain"
        [disabled]="isLoading"
        ></textarea>
        <button class="custom-btn" (click)="explainText()" [disabled]="isExplainDisabled">
          {{ isLoading ? 'Thinking...' : 'Explain' }}
        </button>
        <mat-progress-bar *ngIf="isLoading" mode="indeterminate" class="mb-3"></mat-progress-bar>
    </ng-container>
    <!-- Explanation -->
    <div *ngIf="explanations.length > 0" class="explanation-container" [class.visible]="isExplanationVisible" #explanationContainer>
        <!-- Legend panel -->
        <mat-expansion-panel class="legend-panel mb-4">
            <mat-expansion-panel-header>
              <mat-panel-title>
                Legend
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="legend-content">
              <div class="legend-item">
                <div class="legend-icon-wrapper">
                  <mat-icon>school</mat-icon>
                </div>
                <span>Basic: Simple explanation for beginners</span>
              </div>
              <div class="legend-item">
                <div class="legend-icon-wrapper">
                  <mat-icon>psychology</mat-icon>
                </div>
                <span>Detailed: More in-depth explanation with examples</span>
              </div>
              <div class="legend-item">
                <div class="legend-icon-wrapper">
                  <mat-icon>rocket_launch</mat-icon>
                </div>
                <span>Advanced: Technical explanation for experts</span>
              </div>
              <div class="legend-item">
                <div class="legend-icon-wrapper">
                  <mat-icon>help_outline</mat-icon>
                </div>
                <span>What: Definition and description</span>
              </div>
              <div class="legend-item">
                <div class="legend-icon-wrapper">
                  <mat-icon>lightbulb_outline</mat-icon>
                </div>
                <span>Why: Importance and relevance</span>
              </div>
              <div class="legend-item">
                <div class="legend-icon-wrapper">
                  <mat-icon>settings</mat-icon>
                </div>
                <span>How: Practical application or functioning</span>
              </div>
            </div>
        </mat-expansion-panel>
        <!-- Gist Card -->
        <mat-card *ngIf="mainTakeaway" class="mb-4">
            <mat-card-header>
                <mat-card-title>
                  {{ currentPaperTitle || 'Key Takeaway' }}
                </mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <p>{{ mainTakeaway }}</p>
            </mat-card-content>
            <a *ngIf="currentPaperPdfUrl && mode === 'arXiv'" [href]="currentPaperPdfUrl" target="_blank" rel="noopener noreferrer" class="pdf-link">
              View PDF
            </a>
        </mat-card>
        <!-- Breakdown -->
        <mat-accordion>
            <mat-expansion-panel *ngFor="let topic of explanations">
                <mat-expansion-panel-header>
                    <mat-panel-title>{{ topic.topic }}</mat-panel-title>
                </mat-expansion-panel-header>
                <div *ngFor="let concept of topic.concepts">
                    <mat-card class="mb-3">
                    <mat-card-header>
                        <mat-card-title>{{ concept.concept }}</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <mat-tab-group>
                            <mat-tab>
                                <ng-template mat-tab-label>
                                    <mat-icon matTooltip="Basic">school</mat-icon>
                                </ng-template>
                                <ng-template matTabContent>
                                    <mat-icon>help_outline</mat-icon>
                                    <p>{{ concept.layers[0].what }}</p>
                                    <mat-icon>lightbulb_outline</mat-icon>
                                    <p>{{ concept.layers[0].why }}</p>
                                    <mat-icon>settings</mat-icon>
                                    <p>{{ concept.layers[0].how }}</p>
                                </ng-template>
                            </mat-tab>
                            <mat-tab>
                                <ng-template mat-tab-label>
                                    <mat-icon matTooltip="Detailed">psychology</mat-icon>
                                </ng-template>
                                <ng-template matTabContent>
                                    <mat-icon>help_outline</mat-icon>
                                    <p>{{ concept.layers[1].what }}</p>
                                    <mat-icon>lightbulb_outline</mat-icon>
                                    <p>{{ concept.layers[1].why }}</p>
                                    <mat-icon>settings</mat-icon>
                                    <p>{{ concept.layers[1].how }}</p>
                                </ng-template>
                            </mat-tab>
                            <mat-tab>
                                <ng-template mat-tab-label>
                                    <mat-icon matTooltip="Advanced">rocket_launch</mat-icon>
                                </ng-template>
                                <ng-template matTabContent>
                                    <mat-icon>help_outline</mat-icon>
                                    <p>{{ concept.layers[2].what }}</p>
                                    <mat-icon>lightbulb_outline</mat-icon>
                                    <p>{{ concept.layers[2].why }}</p>
                                    <mat-icon>settings</mat-icon>
                                    <p>{{ concept.layers[2].how }}</p>
                                </ng-template>
                            </mat-tab>
                        </mat-tab-group>
                    </mat-card-content>
                    </mat-card>
                </div>
            </mat-expansion-panel>
        </mat-accordion>
      </div>
  </div>
</div>